{% extends "base.html" %}

{% block title %}Analysis Results - Screenshot News Analyzer{% endblock %}

{% block content %}
<div class="results-container">
    <div class="results-card">
        <h2>Analysis Results</h2>
        <div id="loading-state" class="loading-state">
            <div class="spinner"></div>
            <p id="loading-text">Checking analysis status...</p>
        </div>
        
        <div id="results-content" class="results-content" style="display: none;">
            <!-- Results will be populated by JavaScript -->
        </div>
        
        <div id="error-state" class="error-state" style="display: none;">
            <p id="error-text"></p>
            <button onclick="window.location.href='/'" class="back-btn">Upload Another File</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Get job ID from URL
    const pathParts = window.location.pathname.split('/');
    const jobId = pathParts[pathParts.length - 1];
    
    if (!jobId || jobId === 'results') {
        showError('Invalid job ID');
    } else {
        checkStatus();
    }
    
    async function checkStatus() {
        try {
            const status = await checkJobStatus(jobId);
            updateUI(status);
            
            // Continue polling if not completed
            if (status.status !== 'completed' && status.status !== 'error') {
                setTimeout(checkStatus, 2000);
            }
        } catch (error) {
            showError('Failed to check status: ' + error.message);
        }
    }
    
    function updateUI(status) {
        const loadingState = document.getElementById('loading-state');
        const resultsContent = document.getElementById('results-content');
        const loadingText = document.getElementById('loading-text');
        
        // Update loading text based on status
        const statusMessages = {
            'uploaded': 'Processing uploaded file...',
            'processing': 'Analyzing screenshot content...',
            'extracting_text': 'Extracting text using OCR...',
            'analyzing_text': 'Analyzing text credibility...',
            'analyzing_images': 'Analyzing image authenticity...',
            'generating_report': 'Generating final report...',
            'completed': 'Analysis complete!',
            'error': 'Analysis failed'
        };
        
        loadingText.textContent = statusMessages[status.status] || 'Processing...';
        
        if (status.status === 'completed') {
            showResults(status);
        } else if (status.status === 'error') {
            showError(status.error || 'Analysis failed');
        }
    }
    
    function showResults(status) {
        const loadingState = document.getElementById('loading-state');
        const resultsContent = document.getElementById('results-content');
        
        loadingState.style.display = 'none';
        resultsContent.style.display = 'block';
        
        // Get the full results from the API
        if (status.results) {
            displayFullResults(status);
        } else {
            // Fetch full results if not included in status
            fetchAndDisplayResults(status.job_id, status);
        }
    }
    
    async function fetchAndDisplayResults(jobId, status) {
        try {
            const results = await getJobResults(jobId);
            status.results = results.results;
            displayFullResults(status);
        } catch (error) {
            console.error('Failed to fetch results:', error);
            displayBasicResults(status);
        }
    }
    
    function displayFullResults(status) {
        const resultsContent = document.getElementById('results-content');
        const results = status.results;
        
        if (!results) {
            displayBasicResults(status);
            return;
        }
        
        const finalScore = results.final_score || 0;
        const verdict = results.verdict || 'UNKNOWN';
        const scoreBreakdown = results.score_breakdown || {};
        
        // Get verdict color and emoji
        const verdictInfo = getVerdictInfo(verdict, finalScore);
        
        resultsContent.innerHTML = `
            <div class="analysis-results">
                <div class="results-header">
                    <h2>üìä Analysis Results</h2>
                    <div class="file-info">
                        <p><strong>File:</strong> ${status.filename}</p>
                        <p><strong>Analysis Date:</strong> ${results.analysis_timestamp ? new Date(results.analysis_timestamp).toLocaleString() : 'Just now'}</p>
                    </div>
                </div>
                
                <div class="overall-score-card">
                    <div class="score-circle ${verdictInfo.class}">
                        <div class="score-number">${Math.round(finalScore)}</div>
                        <div class="score-label">Credibility Score</div>
                    </div>
                    <div class="verdict-info">
                        <h3>${verdictInfo.emoji} ${verdict.replace(/_/g, ' ')}</h3>
                        <p class="verdict-description">${verdictInfo.description}</p>
                    </div>
                </div>
                
                <div class="score-breakdown">
                    <h3>üìà Detailed Score Breakdown</h3>
                    <div class="score-bars">
                        ${createScoreBar('Text Credibility', scoreBreakdown.text_score || 0, 'üìù')}
                        ${createScoreBar('Image Authenticity', scoreBreakdown.image_score || 0, 'üñºÔ∏è')}
                        ${createScoreBar('Text-Image Consistency', scoreBreakdown.consistency_score || 0, '‚öñÔ∏è')}
                    </div>
                </div>
                
                ${createDetailedAnalysis(results.detailed_analysis)}
                
                <div class="analysis-metadata">
                    <h3>üîç Analysis Details</h3>
                    <div class="metadata-grid">
                        <div class="metadata-item">
                            <strong>Source Type:</strong> ${results.input_source?.source_type || 'Unknown'}
                        </div>
                        <div class="metadata-item">
                            <strong>Platform:</strong> ${results.input_source?.platform || 'Unknown'}
                        </div>
                        <div class="metadata-item">
                            <strong>Layout:</strong> ${results.input_source?.layout_type || 'Unknown'}
                        </div>
                        <div class="metadata-item">
                            <strong>Job ID:</strong> ${status.job_id}
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button onclick="downloadReport('${status.job_id}')" class="download-btn">üìÑ Download Full Report</button>
                    <button onclick="window.location.href='/'" class="back-btn">üîÑ Analyze Another Screenshot</button>
                </div>
            </div>
        `;
    }
    
    function displayBasicResults(status) {
        const resultsContent = document.getElementById('results-content');
        resultsContent.innerHTML = `
            <div class="result-summary">
                <h3>‚úÖ Analysis Complete!</h3>
                <p><strong>File:</strong> ${status.filename}</p>
                <p><strong>Status:</strong> ${status.status}</p>
                <p><strong>Progress:</strong> ${status.progress}%</p>
                <div class="basic-results">
                    <p>üéâ Your screenshot has been analyzed successfully!</p>
                    <p>The detailed results are being processed. Please refresh the page in a moment.</p>
                    <p><strong>Job ID:</strong> ${status.job_id}</p>
                </div>
                <button onclick="window.location.href='/'" class="back-btn">Analyze Another Screenshot</button>
            </div>
        `;
    }
    
    function getVerdictInfo(verdict, score) {
        const verdictMap = {
            'HIGHLY_CREDIBLE': { 
                emoji: '‚úÖ', 
                class: 'score-excellent', 
                description: 'This content appears highly trustworthy with strong credibility indicators.' 
            },
            'CREDIBLE': { 
                emoji: 'üëç', 
                class: 'score-good', 
                description: 'This content appears mostly credible with minor concerns.' 
            },
            'QUESTIONABLE': { 
                emoji: '‚ö†Ô∏è', 
                class: 'score-warning', 
                description: 'This content has mixed signals - verify before sharing.' 
            },
            'UNRELIABLE': { 
                emoji: '‚ùå', 
                class: 'score-poor', 
                description: 'This content shows multiple red flags and may be unreliable.' 
            },
            'HIGHLY_UNRELIABLE': { 
                emoji: 'üö®', 
                class: 'score-danger', 
                description: 'This content appears highly suspicious - likely fake or misleading.' 
            }
        };
        
        return verdictMap[verdict] || { 
            emoji: '‚ùì', 
            class: 'score-unknown', 
            description: 'Analysis incomplete or uncertain.' 
        };
    }
    
    function createScoreBar(label, score, emoji) {
        const normalizedScore = Math.max(0, Math.min(100, score || 0));
        const colorClass = getScoreColorClass(normalizedScore);
        
        return `
            <div class="score-bar-container">
                <div class="score-bar-header">
                    <span class="score-bar-label">${emoji} ${label}</span>
                    <span class="score-bar-value">${Math.round(normalizedScore)}/100</span>
                </div>
                <div class="score-bar-track">
                    <div class="score-bar-fill ${colorClass}" style="width: ${normalizedScore}%"></div>
                </div>
            </div>
        `;
    }
    
    function getScoreColorClass(score) {
        if (score >= 80) return 'score-excellent';
        if (score >= 60) return 'score-good';
        if (score >= 40) return 'score-warning';
        if (score >= 20) return 'score-poor';
        return 'score-danger';
    }
    
    function createDetailedAnalysis(detailedAnalysis) {
        if (!detailedAnalysis) return '';
        
        let html = '<div class="detailed-analysis"><h3>üî¨ Detailed Analysis</h3>';
        
        // Text Analysis
        if (detailedAnalysis.text_analysis) {
            html += createAnalysisSection('Text Analysis', detailedAnalysis.text_analysis, 'üìù');
        }
        
        // Image Analysis
        if (detailedAnalysis.image_analysis) {
            html += createAnalysisSection('Image Analysis', detailedAnalysis.image_analysis, 'üñºÔ∏è');
        }
        
        // Consistency Analysis
        if (detailedAnalysis.consistency_analysis) {
            html += createAnalysisSection('Consistency Analysis', detailedAnalysis.consistency_analysis, '‚öñÔ∏è');
        }
        
        html += '</div>';
        return html;
    }
    
    function createAnalysisSection(title, analysis, emoji) {
        let html = `<div class="analysis-section">
            <h4>${emoji} ${title}</h4>
            <div class="analysis-content">`;
        
        if (analysis.verdict) {
            html += `<p><strong>Verdict:</strong> ${analysis.verdict}</p>`;
        }
        
        if (analysis.red_flags && analysis.red_flags.length > 0) {
            html += `<div class="red-flags">
                <strong>‚ö†Ô∏è Concerns Found:</strong>
                <ul>`;
            analysis.red_flags.forEach(flag => {
                html += `<li>${flag}</li>`;
            });
            html += `</ul></div>`;
        }
        
        if (analysis.positive_indicators && analysis.positive_indicators.length > 0) {
            html += `<div class="positive-indicators">
                <strong>‚úÖ Positive Indicators:</strong>
                <ul>`;
            analysis.positive_indicators.forEach(indicator => {
                html += `<li>${indicator}</li>`;
            });
            html += `</ul></div>`;
        }
        
        if (analysis.consistency_summary) {
            html += `<p><strong>Summary:</strong> ${analysis.consistency_summary}</p>`;
        }
        
        html += '</div></div>';
        return html;
    }
    
    async function downloadReport(jobId) {
        try {
            const results = await getJobResults(jobId);
            const reportData = JSON.stringify(results.results, null, 2);
            const blob = new Blob([reportData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `analysis-report-${jobId}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        } catch (error) {
            alert('Failed to download report: ' + error.message);
        }
    }
    
    function showError(message) {
        const loadingState = document.getElementById('loading-state');
        const errorState = document.getElementById('error-state');
        const errorText = document.getElementById('error-text');
        
        loadingState.style.display = 'none';
        errorState.style.display = 'block';
        errorText.textContent = message;
    }
</script>
{% endblock %}